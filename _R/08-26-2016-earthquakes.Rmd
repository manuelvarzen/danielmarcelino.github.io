---
title: "4,166 Years of Earthquakes"
author: "Daniel Marcelino"
date: "August 27, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Early Wednesday, this week, a magnitude 6.2 earthquake hit central Italy, about the province of Rieti, detroying several infrastructures and builds, and killing more than 250. [The Centro Nazinale Terremoti (INGV)](http://cnt.rm.ingv.it/) recorded about 200 aftershocks over the next several hours, including a 5.5-magnitude tremor a little after. Here is the distribution of these aftershocks.


No, "Italy has a medium-high seismic hazard (due to the frequency and intensity of phenomena), very high vulnerability (due to the fragility of building, infrastructural, industrial, production and service assets) and an extremely high exposure (due to population density and its historical, artistic and monumental heritage that is one of its kind in the world). Our peninsula therefore has a high seismic risk, in terms of victims, damage to buildings and direct and indirect costs expected after an earthquake." from

What you wrote is sadly true. But with some dutiful clarifications to Do
After the San Francisco earthquake the city was rebuilt with earthquake-resistant features over one hundred years ago. Here in Italy we are aware of the risk of earthquakes for centuries, but in the last 120 years, despite the construction techniques could be safer, there has not been the political will to impose more resistant buildings.
Even more seriously, today the Italian state should spend 100 billion euros just to make it earthquake-proof hospitals in the center-south of the country. Knowing how little care of their people, I leave you to imagine what will be done to prevent other disasters in the next 10 years.
As for this event, unfortunately, responsibility for failure prevention are not so great, in fact almost all the buildings razed to the ground are built before 1900, with walls of stone and clay. The buildings themselves which represent our historical and artistic heritage, that each visit you make to our country admired with taste, are the most at risk and the most difficult to protect from future quakes.

â€œI cannot fail to express my heartfelt sorrow and spiritual closeness to all those present in the zones afflicted,

http://www.understandingitaly.com/profile-content/earthquakes.html

http://www.nature.com/news/italian-seismologists-cleared-of-manslaughter-1.16313

http://www.nature.com/news/italian-court-finds-seismologists-guilty-of-manslaughter-1.11640

http://www.sciencemag.org/news/2015/02/why-italian-earthquake-scientists-were-exonerated

Global Significant Earthquake Database, 2150 B.C. to present

## The data
The used in this post comes from [The National Geophysical Data Center (NGDC)](http://www.ngdc.noaa.gov/). The Global Significant Earthquake Database contains about 5,900 significant earthquakes from 2150 B.C. to present. A chopped version of this database can be dowloaded from this gist <>.  Detailed earthquakes data from the past 30 days comes from [The USGS Earthquake Hazards Program](http://earthquake.usgs.gov/earthquakes/feed/v1.0/csv.php). 

and provides several data on earthquake location and magnitude.

### Loading libraries and data
```{r}
library(reshape2)
library(ggplot2)
library(ggmap)

earthquakes <- read.csv("http://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_month.csv", as.is = T)
head(earthquakes[c("time", "longitude", "latitude", "place", "mag")])
```

### Preprocessing the data
```{r}
earthquakes <- subset(earthquakes, type=="earthquake")
earthquakes$area <- factor(sub("^[^,]+, ", "", earthquakes$place))
# earthquakes <- subset(earthquakes,  area=="Italy")
earthquakes$date <- as.Date(strtrim(earthquakes$time, 19), format = "%Y-%m-%dT%H:%M:%S")
```

### Building a new dataset with magnitude frequencies by day
```{r}
eqFreq1 <- with(earthquakes, table(date, mag))
eqFreq2 <- melt(eqFreq1)
names(eqFreq2) <- c("date", "magnitude", "freq")
head(subset(eqFreq2, freq > 0 & magnitude > 0))
```

### Plotting a stacked bars graph of earthquakes magnitude frequencies by day

```{r}
eqFreq2$magnitude <- factor(round(eqFreq2$magnitude))
ggplot(eqFreq2, aes(date, weight = freq, fill = magnitude)) +
        geom_bar(binwidth = 60 * 60 * 24) +
        labs(x = "Date", y = "Frequency", 
             title = "Earthquakes Frequency from the past 30 days") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
        scale_fill_brewer(palette="BuPu")
```

Using the original dataset to plot a map with the locations of the 100 biggest earthquakes:


```{r}
BiggestMag <- tail(sort(earthquakes$mag), n=100)
#Plotting
library(maps)
world_map <- map_data("world")
ggplot() + coord_fixed() + xlab("") + ylab("") +
        geom_polygon(data = world_map, 
                     aes(x = long, y = lat, group = group), 
                     colour = "light green", fill = "light green") +
        geom_point(aes(x = longitude, y = latitude, size = mag),
                   data = eq[eq$mag %in% BiggestMag ,], 
                   colour = "Deep Pink", fill = "Pink", 
                   pch = 21, alpha = I(0.7)) +
        labs(title="Biggest earthquakes from the past 30 days")

```

Adding layer for two-dimensional density of the data points, we have 

Clearly in the map, the peak of the density or say the bulk of the data points is in Bohol island. Just to give you an idea as to how many points overlapping the island, here are the 143 recorded earthquakes from September 2013. And as you can see, the points are very scattered, expanding the distribution.


On the average, the magnitude of the earthquake is around 3.5 base on the histogram below, with density estimate close to Gaussian distribution.

Salvacion (I hope that's his family name) made a map too for Bohol earthquake using base graphics in R. You might want to check his work.


library(ggplot2)
library(maptools)

edat <- read.csv("~/ShinyApps/Earthquake/EDataOct13.csv", header = TRUE)

Ph <- readShapePoly("~/ShinyApps/Earthquake/Provinces.shp")

#Plot the Shape File overlayed with Data Points from edat
p <- ggplot() +
  geom_polygon(data = Ph,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "#03C03C") +
  coord_fixed() + geom_point(aes(x = Longitude,
                                 y = Latitude,
                                 colour = Depth,
                                 size = Magnitude),
                             data = edat,
                             alpha = 0.80) +
  scale_colour_gradient(low = "orange",
                        high = "#C23B22") +
  labs(title = "Earthquake: October 2013") +
  xlab("Longitude") +
  ylab("Latitude") +
  theme(panel.background = element_rect(
    size = 3,
    colour = "black",
    fill = "white"),
        axis.ticks = element_line(
          size = 2),
        panel.grid.major = element_line(
          colour = "gray80",
          linetype = "dotted"),
        panel.grid.minor = element_line(
          colour = "gray90",
          linetype = "dashed"),
        axis.title.x = element_text(
          size = rel(1.2),
          face = "bold"),
        axis.title.y = element_text(
          size = rel(1.2),
          face = "bold"),
        plot.title = element_text(
          size = 20,
          face = "bold",
          vjust = 1.5)) +
  scale_x_continuous(
    limits = c(114, 130)) +
  scale_y_continuous(
limits = c(3, 22))


labs(title="Global Earthquake Maps (Aug-25-2016)")
"Errors using inadequate data are much less than those using no data at all."â€”Charles Babbage


bayesian_iv.R

# Use the "bayesm" package for a simple Bayesian IV model

```{r}
library(bayesm)

set.seed(66)

simIV = function(delta,beta,Sigma,n,z,w,gamma){
  eps = matrix(rnorm(2*n),ncol=2) %*% chol(Sigma)
  x = z %*% delta + eps[,1]; y = beta*x +  eps[,2] + w%*%gamma
  list(x=as.vector(x),y=as.vector(y)) 
  }

n = 200 ; p=1 # number of instruments
z = cbind(rep(1,n),matrix(runif(n*p),ncol=p))
w = matrix(1,n,1)
rho=.8
Sigma = matrix(c(1,rho,rho,1),ncol=2)
delta = c(1,4); beta = .5; gamma = c(1)
simiv = simIV(delta,beta,Sigma,n,z,w,gamma)

R <- 2000

Mcmc1=list();  Data1 = list()
Data1$z = z; Data1$w=w; Data1$x=simiv$x; Data1$y=simiv$y
Mcmc1$R = R
Mcmc1$keep=1
out=rivGibbs(Data=Data1,Mcmc=Mcmc1)
```

```{r, echo=FALSE}
cat("Summary of Beta draws",fill=TRUE)
```

```{r, echo=FALSE}
summary(out$betadraw,tvalues=beta)
```

```{r, echo=FALSE}
cat("Summary of Sigma draws",fill=TRUE)
Summary of Sigma draws
summary(out$Sigmadraw,tvalues=as.vector(Sigma[upper.tri(Sigma,diag=TRUE)]))
```



## plotting examples
#plot(out$betadraw)

# Replicate the same model using non-Bayesian method

library(AER)


x = simiv$x
y = simiv$y
d <- data.frame(z, w, x, y)

iv <- ivreg(y ~ x | X2, data = d)
summary(iv)

# Code it in Stan and compare the results

library(rstan)



n = length(y)
z = d$X2

model <- "
data {
int<lower=0> n;
matrix[n,2] yt;
vector[n] z;
}

parameters {
real b;
real d;
real a;
real g;
real<lower=0,upper=100> sigma_t;
real<lower=0,upper=100> sigma_y;
real<lower=-1,upper=1> rho_yt;
}

transformed parameters {
cov_matrix[2] Sigma_yt;
matrix[n,2] yt_hat;

Sigma_yt[1,1] <- pow(sigma_y,2);
Sigma_yt[2,2] <- pow(sigma_t,2);
Sigma_yt[1,2] <- rho_yt*sigma_y*sigma_t;
Sigma_yt[2,1] <- Sigma_yt[1,2];


for (i in 1:n) {
  yt_hat[i,2] <- g + d*z[i];
  yt_hat[i,1] <- a + b*yt[i,2];
  }
}

model {
  for (i in 1:n)
  transpose(yt[i]) ~ multi_normal(transpose(yt_hat[i]), Sigma_yt);
}
"

d_list <- list(y1=y, y2=x)
d_matrix <- as.matrix(data.frame(d_list))
data <- list(yt=d_matrix, z=z, n=n)

fit <- stan(model_code = model, data=data, pars=c("a", "b", "d", "g", "sigma_t", "sigma_y", "rho_yt"))

print(fit, digits=3)



